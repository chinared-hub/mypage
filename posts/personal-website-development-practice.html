<!DOCTYPE html><html lang="zh-Hans"><head><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="baidu-site-verification" content="cbUbgjjdru"/><meta name="generator" content="Next.js"/><link href="https://fonts.googleapis.com/css?family=Chelsea+Market:400" rel="stylesheet"/><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500&amp;display=swap" rel="stylesheet"/><link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@300;400;500&amp;display=swap" rel="stylesheet"/><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"/><script src="https://cdn.bootcdn.net/ajax/libs/react/16.13.1/umd/react.production.min.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/react-dom/16.13.1/umd/react-dom.production.min.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.0.3/highlight.min.js"></script><script src="/_.v1.js"></script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>ä¸ªäººç½‘ç«™å¼€å‘å®è·µ - kiyak</title><link rel="preload" href="/_next/static/css/7af46002.794d2e46.chunk.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7af46002.794d2e46.chunk.css" data-n-g=""/><link rel="preload" href="/_next/static/css/189f372a1a09b44bc5ee9e8694cd22967121ee9f_CSS.48deeafe.chunk.css" as="style"/><link rel="stylesheet" href="/_next/static/css/189f372a1a09b44bc5ee9e8694cd22967121ee9f_CSS.48deeafe.chunk.css" data-n-g=""/><link rel="preload" href="/_next/static/css/712a84a73acf62bf26290958298b2566586e7dd8_CSS.77aeb35e.chunk.css" as="style"/><link rel="stylesheet" href="/_next/static/css/712a84a73acf62bf26290958298b2566586e7dd8_CSS.77aeb35e.chunk.css" data-n-g=""/><link rel="preload" href="/_next/static/css/93b2fd6e127d30331b61cfd2f04634ca05024a66_CSS.c9bcc403.chunk.css" as="style"/><link rel="stylesheet" href="/_next/static/css/93b2fd6e127d30331b61cfd2f04634ca05024a66_CSS.c9bcc403.chunk.css" data-n-g=""/><link rel="preload" href="/_next/static/css/styles.a71acdf5.chunk.css" as="style"/><link rel="stylesheet" href="/_next/static/css/styles.a71acdf5.chunk.css" data-n-g=""/><link rel="preload" href="/_next/static/css/8a4b9c7b11a9228b425c7a73cade1154f2ca061e_CSS.0b204744.chunk.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8a4b9c7b11a9228b425c7a73cade1154f2ca061e_CSS.0b204744.chunk.css" data-n-p=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/_next/static/chunks/main-9e14e9299d96e4a63fc3.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-d7b2fb72fb7257504a38.js" as="script"/><link rel="preload" href="/_next/static/chunks/7af46002.7b37a38a8911fc5fb44b.js" as="script"/><link rel="preload" href="/_next/static/chunks/7658eb265201359a3f9e5f36a5d51cd74c781bde.716fe7386381de1064b0.js" as="script"/><link rel="preload" href="/_next/static/chunks/189f372a1a09b44bc5ee9e8694cd22967121ee9f.c1299753f6cf9d140411.js" as="script"/><link rel="preload" href="/_next/static/chunks/189f372a1a09b44bc5ee9e8694cd22967121ee9f_CSS.8f6f5b95f5e92b2c9bcd.js" as="script"/><link rel="preload" href="/_next/static/chunks/712a84a73acf62bf26290958298b2566586e7dd8_CSS.bca366718f045dbe8189.js" as="script"/><link rel="preload" href="/_next/static/chunks/93b2fd6e127d30331b61cfd2f04634ca05024a66_CSS.19830e50427f38e47434.js" as="script"/><link rel="preload" href="/_next/static/chunks/608d37238a334f4b11fe8d600201fe11b7a5b804.cbf6dda1e316f22fd86b.js" as="script"/><link rel="preload" href="/_next/static/chunks/d111f78934af154ae2b78def2cd48076645f6685.b41fcd8fbee89b9b32b6.js" as="script"/><link rel="preload" href="/_next/static/chunks/e70a2e0268e458e8b9abc18785a5727107407f8e.3f5af21948b0ca66102f.js" as="script"/><link rel="preload" href="/_next/static/chunks/styles.97cfe1edb1cdc49560a5.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-307ac3bfcacd4d7be388.js" as="script"/><link rel="preload" href="/_next/static/chunks/8a4b9c7b11a9228b425c7a73cade1154f2ca061e.4a1b4be1a94f0b02499c.js" as="script"/><link rel="preload" href="/_next/static/chunks/8a4b9c7b11a9228b425c7a73cade1154f2ca061e_CSS.4d62413f4da81be1e932.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-c6ffa8c08f20ac6ea580.js" as="script"/></head><body><div id="__next"><div><section class="ant-layout"><header class="ant-layout-header ki-header"><div class="ant-row ant-row-center ant-row-middle" style="height:100%"><div class="title-panel"><a class="header-title" href="/">Â· KIYAK Â·</a></div></div></header><main class="ant-layout-content" style="margin-top:50px;padding-left:2px;padding-right:2px;padding-top:2px"><div style="overflow:hidden"><div id="posts-panel"><div class="ant-row ant-row-center"><div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-18 ant-col-lg-13"><div id="posts-content"><h1>ä¸ªäººç½‘ç«™å¼€å‘å®è·µ</h1>
<p>å¿…å¤‡ï¼š<a href="https://nodejs.org/en/">NodeJs</a> ã€<a href="http://nginx.org/en/download.html">Nginx</a></p>
<h2>ä½¿ç”¨Next.js</h2>
<p>ç½‘ç«™çš„å¼€å‘é‡‡ç”¨ <strong><a href="https://nextjs.org/">Next.js</a></strong>ï¼ŒNext.js å…·æœ‰è‡ªåŠ¨ä»£ç æ‹†åˆ†ã€é¢„æ¸²æŸ“ã€åŸºäºæ–‡ä»¶ç³»ç»Ÿè·¯ç”±ç­‰ç­‰ä¾¿åˆ©äºå¼€å‘çš„ç‰¹æ€§ â˜•</p>
<p>å®˜æ–¹åœ¨ Github ä¸Šåˆ—å‡ºäº†è®¸å¤šä¾‹å­ ğŸ‘‰ <a href="https://github.com/zeit/next.js/tree/canary/examples">example</a> ï¼Œä»¥ <a href="https://github.com/zeit/next.js/tree/canary/examples/with-ant-design-less">with-ant-design-less</a> ä¸ºä¾‹ï¼Œåœ¨ cmd é¢æ¿ä¸‹è¿è¡Œä»¥ä¸‹å‘½ä»¤</p>
<pre><code class="language-sh">npm init next-app --example with-ant-design-less projectname
npm install
npm run dev
</code></pre>
<p>è®¿é—® <a href="http://localhost:3000/">http://localhost:3000</a>ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹é¡µé¢ï¼š</p>
<p><img src="https://resource.1024kb.top/image/code-sample/welcome-to-nextjs.png" alt="Welcome to Next.js">
<small style='text-align: center'>å›¾ç‰‡æ¥è‡ªNext.jså®˜ç½‘</small></p>
<h2>ä½¿ç”¨nginxçš„gzipå‹ç¼©åŠŸèƒ½</h2>
<p>ä¸ºäº†åŠ å¿«è®¿é—®ç½‘ç«™çš„é€Ÿåº¦ï¼Œå¿…é¡»å°†ç½‘ç«™çš„ jsã€cssã€htmlç­‰æ–‡ä»¶å°½é‡å˜å¾—è¶³å¤Ÿå°ï¼Œç½‘ç»œçš„ä¼ è¾“æ‰èƒ½è¶³å¤Ÿå¿«</p>
<p>é¦–å…ˆä½¿ç”¨ webpack å¯è§†åŒ–åˆ†ææ’ä»¶ï¼š <a href="https://www.npmjs.com/package/webpack-bundle-analyzer">webpack-bundle-analyzer</a> ï¼Œå¹¶ä¸”æ„å»ºå·²æœ‰é¡¹ç›®ï¼š<code>npm run build</code><br>
æ„å»ºå°†äº§ç”Ÿçš„æ–‡ä»¶ä¸€ä¸€ç½—åˆ—å¹¶ä¸”ç”Ÿæˆä¾èµ–å…³ç³»å›¾ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://resource.1024kb.top/image/code-sample/webpack-analysis-1.png" alt="img"></p>
<p>è§‚å¯Ÿæ„å»ºçš„æ–‡ä»¶å¤§å°ï¼Œä»¥ 9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc.js ä¸ºä¾‹ï¼Œå¤§å°ä¸º 123.61kbï¼Œåœ¨ç½‘ç»œä¼ è¾“ä¸­ï¼Œ100+kbç®—æ˜¯å¯ä»¥æ¥å—çš„å¤§å°äº†ï¼Œä½†å¹¸è¿çš„æ˜¯ï¼Œè¿˜èƒ½åšåˆ°æ›´å°ï¼</p>
<p><img src="https://resource.1024kb.top/image/code-sample/webpack-analysis-2.png" alt="img"></p>
<p>nginx æä¾›äº†ä¸€ä¸ªå¼€ç®±å³ç”¨çš„å‹ç¼©åŠŸèƒ½ <strong>gzip</strong>ï¼Œä½†é»˜è®¤æƒ…å†µä¸‹ï¼Œgzip è®¾ç½®æ˜¯ä¸å¼€å¯çš„ï¼Œåœ¨å®˜ç½‘ä¸‹è½½çš„ nginx é‡Œï¼Œnginx.conf æ–‡ä»¶ä¼šæœ‰è¿™ä¸€è¡Œä»£ç ï¼š</p>
<pre><code class="language-nginx">#gzip on;
</code></pre>
<p>æ­¤æ—¶å¯¹ gzip åŠŸèƒ½ä¸åšä»»ä½•å˜åŠ¨ï¼Œå°†æ„å»ºå¥½çš„é™æ€é¡¹ç›®æ”¾å…¥ nginx å¹¶ä¸”å¯åŠ¨æœ¬åœ°æœåŠ¡ã€‚æ‰“å¼€ç½‘é¡µï¼Œæœç´¢æ–‡ä»¶åç§° 9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc.js</p>
<p><img src="https://resource.1024kb.top/image/code-sample/9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc.png" alt="img"></p>
<p>å¯ä»¥çœ‹åˆ°æ–‡ä»¶ä¼ è¾“çš„å¤§å°ä¸ºï¼š127kb (å·¦ä¸‹è§’ - transferred)</p>
<p>é‡æ–°æ‰“å¼€ nginx.conf æ–‡ä»¶å¹¶ä¸”ç¼–è¾‘å¦‚ä¸‹å†…å®¹ï¼š</p>
<pre><code class="language-nginx">#å¼€å¯gzipå‹ç¼©
gzip on;
#å‹ç¼©çº§åˆ«1~9ï¼Œå€¼è¶Šå¤§å‹ç¼©è¶Šå¥½ï¼Œä½†è€—è´¹è¶Šå¤šCPUèµ„æº
gzip_comp_level 1;
#æ–‡ä»¶å¤§äº1kæ‰è¿›è¡Œå‹ç¼©
gzip_min_length 1k;
#gzåç¼€æ–‡ä»¶ä¸å‹ç¼©
gzip_static off;
#æ˜¯å¦åœ¨http headerä¸­æ·»åŠ Vary: Accept-Encoding
gzip_vary on;
#æŒ‡å®šå‹ç¼©çš„æ–‡ä»¶ç±»å‹
gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript;
#æŒ‡å®šå‹ç¼©ç¼“å†²å¤§å°
gzip_buffers 2 4k;
</code></pre>
<p>ä¿å­˜ä¹‹åé‡æ–°å¯åŠ¨ nginxï¼š<code>nginx -s reload</code>ï¼Œå†æ¬¡è®¿é—®ç½‘é¡µ</p>
<p><img src="https://resource.1024kb.top/image/code-sample/9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc-2.png" alt="img"></p>
<p>å“åº”å¤´å¢åŠ äº† <code>Content-Encoding: gzip</code>ï¼Œæ–‡ä»¶ä¹Ÿå‡å°äº†ï¼Œå˜æˆ41.6kbï¼</p>
<h2>ä½¿ç”¨nginxç¼“å­˜</h2>
<p>åŒæ ·åœ¨ nginx.conf æ–‡ä»¶é‡Œå¢åŠ å¦‚ä¸‹å†…å®¹ï¼Œé‡å¯ nginx</p>
<pre><code class="language-nginx">#å›¾ç‰‡ç¼“å­˜æ—¶é—´è®¾ç½®
location ~* \.(gif|jpg|jpeg|png|bmp|swf|ico)$ {
    expires 24h;
    add_header Cache-Control "public";
}
#JSå’ŒCSSç¼“å­˜æ—¶é—´è®¾ç½®
location ~* \.(js|css)$ {
    expires 24h;
    add_header Cache-Control "public";
}
</code></pre>
<p>é‡æ–°æŸ¥çœ‹è¯·æ±‚çš„å“åº”å¤´ä¼šå¤šå‡ºä¸€è¡ŒæŒ‡ä»¤ï¼š <strong>Cache-Control: max-age=86400</strong>ï¼Œè¿™å¯ä»¥å‘Šè¯‰å®¢æˆ·ç«¯å°†æ–‡ä»¶å­˜åˆ°æœ¬åœ°ï¼Œåœ¨æŸæ®µæ—¶é—´å†…(86400s)éƒ½å°†ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½å»è¯·æ±‚æœåŠ¡å™¨ã€‚å¯å‡ç¼“æœåŠ¡å‹åŠ›ï¼ŒåŒæ—¶æé«˜é¡µé¢å“åº”é€Ÿåº¦</p>
<h2>ä½¿ç”¨compression-webpack-pluginæ’ä»¶</h2>
<blockquote>
<p>Prepare compressed versions of assets to serve them with Content-Encoding.</p>
</blockquote>
<p>è¯¥æ’ä»¶å¯å°† webpack æ„å»ºç”Ÿæˆçš„æ–‡ä»¶è¿›è¡Œ gzip å‹ç¼©ï¼Œç”Ÿæˆå¯¹åº”çš„ gz æ–‡ä»¶</p>
<p>ä¾‹å¦‚ webpack æ„å»ºå¹¶ä¸”ç”Ÿæˆæ–‡ä»¶ï¼š</p>
<p>xxx.js - 80kb</p>
<hr>
<p>ä½¿ç”¨äº† compression-webpack-plugin æ’ä»¶ä¹‹åï¼š</p>
<p>xxx.js - 80kb</p>
<p>xxx.js.gz - 3kb</p>
<hr>
<p>è¯¥åšæ³•æ—¨åœ¨æå‰å°†æ–‡ä»¶è¿›è¡Œå‹ç¼©ï¼Œåœ¨æ¨é€åˆ°æœåŠ¡å™¨ä¹‹åå¯ç›´æ¥ä½¿ç”¨å‹ç¼©å¥½çš„ gz æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æœåŠ¡å™¨çš„ CPU èµ„æºè¿›è¡Œæ–‡ä»¶çš„å‹ç¼©æ“ä½œã€‚è¦æƒ³ nginx èƒ½å¤Ÿç›´æ¥åˆ©ç”¨ gz æ–‡ä»¶ï¼Œéœ€è¦å¼€å¯ gzip_static åŠŸèƒ½ã€‚</p>
<pre><code class="language-nginx">gzip_static on;
</code></pre>
<h2>éƒ¨ç½²</h2>
<p>é‡‡ç”¨ Jenkins ã€Gitã€Docker å®ç°å¿«é€Ÿçš„ç‰ˆæœ¬è¿­ä»£æ›´æ–°ã€‚</p>
<p><img src="https://resource.1024kb.top/image/code-sample/CI&#x26;CD.png?v=2" alt="img"></p>
<p>æ€è·¯ï¼š</p>
<ol>
<li>å°†æœ¬åœ°å¼€å‘çš„ä»£ç æäº¤ github </li>
<li>å¯åŠ¨ Jenkins æµæ°´çº¿<ol>
<li>æ‹‰å–æœ€æ–°ä»£ç ï¼šgit pull</li>
<li>ä¸‹è½½ä¾èµ–ï¼š npm i</li>
<li>æ„å»ºé¡¹ç›®ï¼šnpm run build</li>
<li>æ‰“åŒ…å¿…è¦æ–‡ä»¶ï¼šnginx.confã€start.sh<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup> ã€Dockerfileã€out<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup></li>
</ol></li>
<li>å°†æ‰“åŒ…å¥½çš„æ–‡ä»¶å‘å¸ƒåˆ° Cenos æœåŠ¡å™¨ï¼Œæ‰§è¡Œ start.sh</li>
<li>Docker ç”Ÿæˆ nginx é•œåƒï¼Œæ ¹æ®é•œåƒæ„å»ºä¸€ä¸ª Docker å®¹å™¨ï¼Œå¹¶å°† nginx.confã€out æ–‡ä»¶æ”¾å…¥å®¹å™¨æŒ‡å®šçš„ä½ç½®</li>
</ol>
<p>start.sh</p>
<pre><code class="language-sh">#!/bin/bash
BASE_PATH=/kiyak/kiyak-web
SERVER_NAME=kiyak-web
KIYAK_CONTAINER=$(docker ps -a | grep "${SERVER_NAME}" | awk '{print $1}')
KIYAK_IMAGE=$(docker images | grep "${SERVER_NAME}" | awk '{print $3}')
KIYAK_NET_WORK=snail-net

# æ„å»ºdockeré•œåƒ
if [ -n "$KIYAK_CONTAINER" ]
then
  echo "å­˜åœ¨$SERVER_NAMEå®¹å™¨ï¼ŒID=$KIYAK_CONTAINER"
  echo "åœæ­¢$SERVER_NAMEå®¹å™¨ï¼ŒID=$KIYAK_CONTAINER"
  docker stop $KIYAK_CONTAINER
  echo "åˆ é™¤$SERVER_NAMEå®¹å™¨ï¼ŒID=$KIYAK_CONTAINER"
  docker rm $KIYAK_CONTAINER
fi

if [ -n "$KIYAK_IMAGE" ]
then
  echo "å­˜åœ¨$SERVER_NAMEé•œåƒï¼ŒID=$KIYAK_IMAGE"
  echo "åˆ é™¤$SERVER_NAMEé•œåƒï¼ŒID=$KIYAK_IMAGE"
  docker image rm $KIYAK_IMAGE
fi

cd $BASE_PATH
echo "åˆ›å»º$SERVER_NAMEé•œåƒ......"
docker build -t $SERVER_NAME .
echo "å¯åŠ¨$SERVER_NAMEå®¹å™¨......"
docker run --name $SERVER_NAME -u root -p 80:80 -p 443:443 -v /etc/localtime:/etc/localtime:ro -v /kiyak/web-log:/etc/nginx/logs --network $KIYAK_NET_WORK -d $SERVER_NAME

# æ¸…ç†æ–‡ä»¶
rm -rf $BASE_PATH/*
</code></pre>
<p>Dockerfile</p>
<pre><code class="language-markdown">FROM nginx
EXPOSE 80 443
ADD kiyak-web.tar.gz /etc/nginx/kiyak-web/
ADD cert.tar.gz /etc/nginx/
COPY nginx.conf /etc/nginx/nginx.conf
</code></pre>
<h1>å‚è€ƒèµ„æ–™</h1>
<ul>
<li>Jeff Posnick, Ilya Grigorik, Prevent unnecessary network requests with the HTTP Cache, <em>web.dev</em>, 2020. <a href="https://web.dev/http-cache/">ğŸ“„</a></li>
<li>Marc Novakowski, Oliver Weichhold, â€œETag vs Header Expiresâ€, <em>Stack Overflow</em>, 2014 <a href="https://stackoverflow.com/a/500103">ğŸ“„</a></li>
</ul>
<div class="footnotes">
<hr>
<ol>
<li id="fn-1">Shell è„šæœ¬ï¼Œä¸»è¦é›†æˆæ“ä½œ docker çš„å„ç§å‘½ä»¤è¡Œ<a href="#fnref-1" class="footnote-backref">â†©</a></li>
<li id="fn-2">webpack æ„å»ºç”Ÿæˆçš„æ–‡ä»¶å¤¹ï¼Œé‡Œé¢åŒ…å«é¡¹ç›®çš„æ‰€æœ‰é™æ€æ–‡ä»¶ï¼šjsã€cssã€html<a href="#fnref-2" class="footnote-backref">â†©</a></li>
</ol>
</div>
</div></div></div><div style="position:fixed;bottom:150px;right:50px"><nav id="posts-nav"><ul style="list-style:none"></ul></nav></div><div class="ant-row ant-row-center" style="margin-bottom:40px;margin-top:40px"><span class="ant-typography"><u>Â· last updatedï¼š<!-- --> Â·</u></span></div></div></div><span style="position:fixed;bottom:60px;right:15px;z-index:999;background-color:#555555" class="ant-avatar ant-avatar-lg ant-avatar-circle ant-avatar-icon ant-dropdown-trigger"><span role="img" aria-label="unordered-list" class="anticon anticon-unordered-list"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="unordered-list" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 10112 0 56 56 0 10-112 0zm0 284a56 56 0 10112 0 56 56 0 10-112 0zm0 284a56 56 0 10112 0 56 56 0 10-112 0z"></path></svg></span></span><div style="display:none" class="web-map"><a href="/">ä¸»é¡µ</a><a href="/notes">ç¬”è®°</a></div></main><footer class="ant-layout-footer ki-footer"><a href="http://www.beian.miit.gov.cn" target="_blank" style="color:rgba(250, 250, 250, 0.938)">æ¡‚ICPå¤‡18000815å·-2 Â© 2017 - 2020 - KIYAK-WEB</a></footer></section></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"filename":"ä¸ªäººç½‘ç«™å¼€å‘å®è·µ.md","title":"ä¸ªäººç½‘ç«™å¼€å‘å®è·µ","excerpt":"è®°å½•ä¸‹ä¸€äº›å¼€å‘å†…å®¹æˆ–è€…ä¼˜åŒ–å¿ƒå¾—","date":"2019-01-20T18:35:07.322Z","updated":"2020-05-26T14:02:00.000Z","preText":"ğŸ‘","preTextColor":"#ffddbb","content":"\u003ch1\u003eä¸ªäººç½‘ç«™å¼€å‘å®è·µ\u003c/h1\u003e\n\u003cp\u003eå¿…å¤‡ï¼š\u003ca href=\"https://nodejs.org/en/\"\u003eNodeJs\u003c/a\u003e ã€\u003ca href=\"http://nginx.org/en/download.html\"\u003eNginx\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003eä½¿ç”¨Next.js\u003c/h2\u003e\n\u003cp\u003eç½‘ç«™çš„å¼€å‘é‡‡ç”¨ \u003cstrong\u003e\u003ca href=\"https://nextjs.org/\"\u003eNext.js\u003c/a\u003e\u003c/strong\u003eï¼ŒNext.js å…·æœ‰è‡ªåŠ¨ä»£ç æ‹†åˆ†ã€é¢„æ¸²æŸ“ã€åŸºäºæ–‡ä»¶ç³»ç»Ÿè·¯ç”±ç­‰ç­‰ä¾¿åˆ©äºå¼€å‘çš„ç‰¹æ€§ â˜•\u003c/p\u003e\n\u003cp\u003eå®˜æ–¹åœ¨ Github ä¸Šåˆ—å‡ºäº†è®¸å¤šä¾‹å­ ğŸ‘‰ \u003ca href=\"https://github.com/zeit/next.js/tree/canary/examples\"\u003eexample\u003c/a\u003e ï¼Œä»¥ \u003ca href=\"https://github.com/zeit/next.js/tree/canary/examples/with-ant-design-less\"\u003ewith-ant-design-less\u003c/a\u003e ä¸ºä¾‹ï¼Œåœ¨ cmd é¢æ¿ä¸‹è¿è¡Œä»¥ä¸‹å‘½ä»¤\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sh\"\u003enpm init next-app --example with-ant-design-less projectname\nnpm install\nnpm run dev\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè®¿é—® \u003ca href=\"http://localhost:3000/\"\u003ehttp://localhost:3000\u003c/a\u003eï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹é¡µé¢ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://resource.1024kb.top/image/code-sample/welcome-to-nextjs.png\" alt=\"Welcome to Next.js\"\u003e\n\u003csmall style='text-align: center'\u003eå›¾ç‰‡æ¥è‡ªNext.jså®˜ç½‘\u003c/small\u003e\u003c/p\u003e\n\u003ch2\u003eä½¿ç”¨nginxçš„gzipå‹ç¼©åŠŸèƒ½\u003c/h2\u003e\n\u003cp\u003eä¸ºäº†åŠ å¿«è®¿é—®ç½‘ç«™çš„é€Ÿåº¦ï¼Œå¿…é¡»å°†ç½‘ç«™çš„ jsã€cssã€htmlç­‰æ–‡ä»¶å°½é‡å˜å¾—è¶³å¤Ÿå°ï¼Œç½‘ç»œçš„ä¼ è¾“æ‰èƒ½è¶³å¤Ÿå¿«\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆä½¿ç”¨ webpack å¯è§†åŒ–åˆ†ææ’ä»¶ï¼š \u003ca href=\"https://www.npmjs.com/package/webpack-bundle-analyzer\"\u003ewebpack-bundle-analyzer\u003c/a\u003e ï¼Œå¹¶ä¸”æ„å»ºå·²æœ‰é¡¹ç›®ï¼š\u003ccode\u003enpm run build\u003c/code\u003e\u003cbr\u003e\næ„å»ºå°†äº§ç”Ÿçš„æ–‡ä»¶ä¸€ä¸€ç½—åˆ—å¹¶ä¸”ç”Ÿæˆä¾èµ–å…³ç³»å›¾ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://resource.1024kb.top/image/code-sample/webpack-analysis-1.png\" alt=\"img\"\u003e\u003c/p\u003e\n\u003cp\u003eè§‚å¯Ÿæ„å»ºçš„æ–‡ä»¶å¤§å°ï¼Œä»¥ 9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc.js ä¸ºä¾‹ï¼Œå¤§å°ä¸º 123.61kbï¼Œåœ¨ç½‘ç»œä¼ è¾“ä¸­ï¼Œ100+kbç®—æ˜¯å¯ä»¥æ¥å—çš„å¤§å°äº†ï¼Œä½†å¹¸è¿çš„æ˜¯ï¼Œè¿˜èƒ½åšåˆ°æ›´å°ï¼\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://resource.1024kb.top/image/code-sample/webpack-analysis-2.png\" alt=\"img\"\u003e\u003c/p\u003e\n\u003cp\u003enginx æä¾›äº†ä¸€ä¸ªå¼€ç®±å³ç”¨çš„å‹ç¼©åŠŸèƒ½ \u003cstrong\u003egzip\u003c/strong\u003eï¼Œä½†é»˜è®¤æƒ…å†µä¸‹ï¼Œgzip è®¾ç½®æ˜¯ä¸å¼€å¯çš„ï¼Œåœ¨å®˜ç½‘ä¸‹è½½çš„ nginx é‡Œï¼Œnginx.conf æ–‡ä»¶ä¼šæœ‰è¿™ä¸€è¡Œä»£ç ï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-nginx\"\u003e#gzip on;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæ­¤æ—¶å¯¹ gzip åŠŸèƒ½ä¸åšä»»ä½•å˜åŠ¨ï¼Œå°†æ„å»ºå¥½çš„é™æ€é¡¹ç›®æ”¾å…¥ nginx å¹¶ä¸”å¯åŠ¨æœ¬åœ°æœåŠ¡ã€‚æ‰“å¼€ç½‘é¡µï¼Œæœç´¢æ–‡ä»¶åç§° 9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc.js\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://resource.1024kb.top/image/code-sample/9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc.png\" alt=\"img\"\u003e\u003c/p\u003e\n\u003cp\u003eå¯ä»¥çœ‹åˆ°æ–‡ä»¶ä¼ è¾“çš„å¤§å°ä¸ºï¼š127kb (å·¦ä¸‹è§’ - transferred)\u003c/p\u003e\n\u003cp\u003eé‡æ–°æ‰“å¼€ nginx.conf æ–‡ä»¶å¹¶ä¸”ç¼–è¾‘å¦‚ä¸‹å†…å®¹ï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-nginx\"\u003e#å¼€å¯gzipå‹ç¼©\ngzip on;\n#å‹ç¼©çº§åˆ«1~9ï¼Œå€¼è¶Šå¤§å‹ç¼©è¶Šå¥½ï¼Œä½†è€—è´¹è¶Šå¤šCPUèµ„æº\ngzip_comp_level 1;\n#æ–‡ä»¶å¤§äº1kæ‰è¿›è¡Œå‹ç¼©\ngzip_min_length 1k;\n#gzåç¼€æ–‡ä»¶ä¸å‹ç¼©\ngzip_static off;\n#æ˜¯å¦åœ¨http headerä¸­æ·»åŠ Vary: Accept-Encoding\ngzip_vary on;\n#æŒ‡å®šå‹ç¼©çš„æ–‡ä»¶ç±»å‹\ngzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript;\n#æŒ‡å®šå‹ç¼©ç¼“å†²å¤§å°\ngzip_buffers 2 4k;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä¿å­˜ä¹‹åé‡æ–°å¯åŠ¨ nginxï¼š\u003ccode\u003enginx -s reload\u003c/code\u003eï¼Œå†æ¬¡è®¿é—®ç½‘é¡µ\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://resource.1024kb.top/image/code-sample/9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc-2.png\" alt=\"img\"\u003e\u003c/p\u003e\n\u003cp\u003eå“åº”å¤´å¢åŠ äº† \u003ccode\u003eContent-Encoding: gzip\u003c/code\u003eï¼Œæ–‡ä»¶ä¹Ÿå‡å°äº†ï¼Œå˜æˆ41.6kbï¼\u003c/p\u003e\n\u003ch2\u003eä½¿ç”¨nginxç¼“å­˜\u003c/h2\u003e\n\u003cp\u003eåŒæ ·åœ¨ nginx.conf æ–‡ä»¶é‡Œå¢åŠ å¦‚ä¸‹å†…å®¹ï¼Œé‡å¯ nginx\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-nginx\"\u003e#å›¾ç‰‡ç¼“å­˜æ—¶é—´è®¾ç½®\nlocation ~* \\.(gif|jpg|jpeg|png|bmp|swf|ico)$ {\n    expires 24h;\n    add_header Cache-Control \"public\";\n}\n#JSå’ŒCSSç¼“å­˜æ—¶é—´è®¾ç½®\nlocation ~* \\.(js|css)$ {\n    expires 24h;\n    add_header Cache-Control \"public\";\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eé‡æ–°æŸ¥çœ‹è¯·æ±‚çš„å“åº”å¤´ä¼šå¤šå‡ºä¸€è¡ŒæŒ‡ä»¤ï¼š \u003cstrong\u003eCache-Control: max-age=86400\u003c/strong\u003eï¼Œè¿™å¯ä»¥å‘Šè¯‰å®¢æˆ·ç«¯å°†æ–‡ä»¶å­˜åˆ°æœ¬åœ°ï¼Œåœ¨æŸæ®µæ—¶é—´å†…(86400s)éƒ½å°†ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½å»è¯·æ±‚æœåŠ¡å™¨ã€‚å¯å‡ç¼“æœåŠ¡å‹åŠ›ï¼ŒåŒæ—¶æé«˜é¡µé¢å“åº”é€Ÿåº¦\u003c/p\u003e\n\u003ch2\u003eä½¿ç”¨compression-webpack-pluginæ’ä»¶\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003ePrepare compressed versions of assets to serve them with Content-Encoding.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eè¯¥æ’ä»¶å¯å°† webpack æ„å»ºç”Ÿæˆçš„æ–‡ä»¶è¿›è¡Œ gzip å‹ç¼©ï¼Œç”Ÿæˆå¯¹åº”çš„ gz æ–‡ä»¶\u003c/p\u003e\n\u003cp\u003eä¾‹å¦‚ webpack æ„å»ºå¹¶ä¸”ç”Ÿæˆæ–‡ä»¶ï¼š\u003c/p\u003e\n\u003cp\u003exxx.js - 80kb\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eä½¿ç”¨äº† compression-webpack-plugin æ’ä»¶ä¹‹åï¼š\u003c/p\u003e\n\u003cp\u003exxx.js - 80kb\u003c/p\u003e\n\u003cp\u003exxx.js.gz - 3kb\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eè¯¥åšæ³•æ—¨åœ¨æå‰å°†æ–‡ä»¶è¿›è¡Œå‹ç¼©ï¼Œåœ¨æ¨é€åˆ°æœåŠ¡å™¨ä¹‹åå¯ç›´æ¥ä½¿ç”¨å‹ç¼©å¥½çš„ gz æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æœåŠ¡å™¨çš„ CPU èµ„æºè¿›è¡Œæ–‡ä»¶çš„å‹ç¼©æ“ä½œã€‚è¦æƒ³ nginx èƒ½å¤Ÿç›´æ¥åˆ©ç”¨ gz æ–‡ä»¶ï¼Œéœ€è¦å¼€å¯ gzip_static åŠŸèƒ½ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-nginx\"\u003egzip_static on;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eéƒ¨ç½²\u003c/h2\u003e\n\u003cp\u003eé‡‡ç”¨ Jenkins ã€Gitã€Docker å®ç°å¿«é€Ÿçš„ç‰ˆæœ¬è¿­ä»£æ›´æ–°ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://resource.1024kb.top/image/code-sample/CI\u0026#x26;CD.png?v=2\" alt=\"img\"\u003e\u003c/p\u003e\n\u003cp\u003eæ€è·¯ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eå°†æœ¬åœ°å¼€å‘çš„ä»£ç æäº¤ github \u003c/li\u003e\n\u003cli\u003eå¯åŠ¨ Jenkins æµæ°´çº¿\u003col\u003e\n\u003cli\u003eæ‹‰å–æœ€æ–°ä»£ç ï¼šgit pull\u003c/li\u003e\n\u003cli\u003eä¸‹è½½ä¾èµ–ï¼š npm i\u003c/li\u003e\n\u003cli\u003eæ„å»ºé¡¹ç›®ï¼šnpm run build\u003c/li\u003e\n\u003cli\u003eæ‰“åŒ…å¿…è¦æ–‡ä»¶ï¼šnginx.confã€start.sh\u003csup id=\"fnref-1\"\u003e\u003ca href=\"#fn-1\" class=\"footnote-ref\"\u003e1\u003c/a\u003e\u003c/sup\u003e ã€Dockerfileã€out\u003csup id=\"fnref-2\"\u003e\u003ca href=\"#fn-2\" class=\"footnote-ref\"\u003e2\u003c/a\u003e\u003c/sup\u003e\u003c/li\u003e\n\u003c/ol\u003e\u003c/li\u003e\n\u003cli\u003eå°†æ‰“åŒ…å¥½çš„æ–‡ä»¶å‘å¸ƒåˆ° Cenos æœåŠ¡å™¨ï¼Œæ‰§è¡Œ start.sh\u003c/li\u003e\n\u003cli\u003eDocker ç”Ÿæˆ nginx é•œåƒï¼Œæ ¹æ®é•œåƒæ„å»ºä¸€ä¸ª Docker å®¹å™¨ï¼Œå¹¶å°† nginx.confã€out æ–‡ä»¶æ”¾å…¥å®¹å™¨æŒ‡å®šçš„ä½ç½®\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003estart.sh\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sh\"\u003e#!/bin/bash\nBASE_PATH=/kiyak/kiyak-web\nSERVER_NAME=kiyak-web\nKIYAK_CONTAINER=$(docker ps -a | grep \"${SERVER_NAME}\" | awk '{print $1}')\nKIYAK_IMAGE=$(docker images | grep \"${SERVER_NAME}\" | awk '{print $3}')\nKIYAK_NET_WORK=snail-net\n\n# æ„å»ºdockeré•œåƒ\nif [ -n \"$KIYAK_CONTAINER\" ]\nthen\n  echo \"å­˜åœ¨$SERVER_NAMEå®¹å™¨ï¼ŒID=$KIYAK_CONTAINER\"\n  echo \"åœæ­¢$SERVER_NAMEå®¹å™¨ï¼ŒID=$KIYAK_CONTAINER\"\n  docker stop $KIYAK_CONTAINER\n  echo \"åˆ é™¤$SERVER_NAMEå®¹å™¨ï¼ŒID=$KIYAK_CONTAINER\"\n  docker rm $KIYAK_CONTAINER\nfi\n\nif [ -n \"$KIYAK_IMAGE\" ]\nthen\n  echo \"å­˜åœ¨$SERVER_NAMEé•œåƒï¼ŒID=$KIYAK_IMAGE\"\n  echo \"åˆ é™¤$SERVER_NAMEé•œåƒï¼ŒID=$KIYAK_IMAGE\"\n  docker image rm $KIYAK_IMAGE\nfi\n\ncd $BASE_PATH\necho \"åˆ›å»º$SERVER_NAMEé•œåƒ......\"\ndocker build -t $SERVER_NAME .\necho \"å¯åŠ¨$SERVER_NAMEå®¹å™¨......\"\ndocker run --name $SERVER_NAME -u root -p 80:80 -p 443:443 -v /etc/localtime:/etc/localtime:ro -v /kiyak/web-log:/etc/nginx/logs --network $KIYAK_NET_WORK -d $SERVER_NAME\n\n# æ¸…ç†æ–‡ä»¶\nrm -rf $BASE_PATH/*\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eDockerfile\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-markdown\"\u003eFROM nginx\nEXPOSE 80 443\nADD kiyak-web.tar.gz /etc/nginx/kiyak-web/\nADD cert.tar.gz /etc/nginx/\nCOPY nginx.conf /etc/nginx/nginx.conf\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eå‚è€ƒèµ„æ–™\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eJeff Posnick, Ilya Grigorik, Prevent unnecessary network requests with the HTTP Cache, \u003cem\u003eweb.dev\u003c/em\u003e, 2020. \u003ca href=\"https://web.dev/http-cache/\"\u003eğŸ“„\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eMarc Novakowski, Oliver Weichhold, â€œETag vs Header Expiresâ€, \u003cem\u003eStack Overflow\u003c/em\u003e, 2014 \u003ca href=\"https://stackoverflow.com/a/500103\"\u003eğŸ“„\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr\u003e\n\u003col\u003e\n\u003cli id=\"fn-1\"\u003eShell è„šæœ¬ï¼Œä¸»è¦é›†æˆæ“ä½œ docker çš„å„ç§å‘½ä»¤è¡Œ\u003ca href=\"#fnref-1\" class=\"footnote-backref\"\u003eâ†©\u003c/a\u003e\u003c/li\u003e\n\u003cli id=\"fn-2\"\u003ewebpack æ„å»ºç”Ÿæˆçš„æ–‡ä»¶å¤¹ï¼Œé‡Œé¢åŒ…å«é¡¹ç›®çš„æ‰€æœ‰é™æ€æ–‡ä»¶ï¼šjsã€cssã€html\u003ca href=\"#fnref-2\" class=\"footnote-backref\"\u003eâ†©\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/div\u003e\n"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"personal-website-development-practice"},"buildId":"pGGBVmnLCT4XKOq0_CdKw","nextExport":false,"isFallback":false,"gsp":true,"head":[["meta",{"name":"viewport","content":"width=device-width"}],["meta",{"charSet":"utf-8"}],["title",{"children":"ä¸ªäººç½‘ç«™å¼€å‘å®è·µ - kiyak"}]]}</script><script nomodule="" src="/_next/static/chunks/polyfills-577caaa53936537aa4bf.js"></script><script src="/_next/static/chunks/main-9e14e9299d96e4a63fc3.js" async=""></script><script src="/_next/static/chunks/webpack-d7b2fb72fb7257504a38.js" async=""></script><script src="/_next/static/chunks/7af46002.7b37a38a8911fc5fb44b.js" async=""></script><script src="/_next/static/chunks/7658eb265201359a3f9e5f36a5d51cd74c781bde.716fe7386381de1064b0.js" async=""></script><script src="/_next/static/chunks/189f372a1a09b44bc5ee9e8694cd22967121ee9f.c1299753f6cf9d140411.js" async=""></script><script src="/_next/static/chunks/189f372a1a09b44bc5ee9e8694cd22967121ee9f_CSS.8f6f5b95f5e92b2c9bcd.js" async=""></script><script src="/_next/static/chunks/712a84a73acf62bf26290958298b2566586e7dd8_CSS.bca366718f045dbe8189.js" async=""></script><script src="/_next/static/chunks/93b2fd6e127d30331b61cfd2f04634ca05024a66_CSS.19830e50427f38e47434.js" async=""></script><script src="/_next/static/chunks/608d37238a334f4b11fe8d600201fe11b7a5b804.cbf6dda1e316f22fd86b.js" async=""></script><script src="/_next/static/chunks/d111f78934af154ae2b78def2cd48076645f6685.b41fcd8fbee89b9b32b6.js" async=""></script><script src="/_next/static/chunks/e70a2e0268e458e8b9abc18785a5727107407f8e.3f5af21948b0ca66102f.js" async=""></script><script src="/_next/static/chunks/styles.97cfe1edb1cdc49560a5.js" async=""></script><script src="/_next/static/chunks/pages/_app-307ac3bfcacd4d7be388.js" async=""></script><script src="/_next/static/chunks/8a4b9c7b11a9228b425c7a73cade1154f2ca061e.4a1b4be1a94f0b02499c.js" async=""></script><script src="/_next/static/chunks/8a4b9c7b11a9228b425c7a73cade1154f2ca061e_CSS.4d62413f4da81be1e932.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-c6ffa8c08f20ac6ea580.js" async=""></script><script src="/_next/static/pGGBVmnLCT4XKOq0_CdKw/_buildManifest.js" async=""></script><script src="/_next/static/pGGBVmnLCT4XKOq0_CdKw/_ssgManifest.js" async=""></script></body></html>