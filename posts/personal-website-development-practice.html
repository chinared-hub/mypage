<!DOCTYPE html><html lang="zh-Hans"><head><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="baidu-site-verification" content="cbUbgjjdru"/><meta name="generator" content="Next.js"/><link href="https://fonts.googleapis.com/css?family=Chelsea+Market:400" rel="stylesheet"/><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500&amp;display=swap" rel="stylesheet"/><link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@300;400;500&amp;display=swap" rel="stylesheet"/><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"/><script src="https://cdn.bootcdn.net/ajax/libs/react/16.13.1/umd/react.production.min.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/react-dom/16.13.1/umd/react-dom.production.min.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.0.3/highlight.min.js"></script><script src="/_.v1.js"></script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>个人网站开发实践 - kiyak</title><link rel="preload" href="/_next/static/css/7af46002.794d2e46.chunk.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7af46002.794d2e46.chunk.css" data-n-g=""/><link rel="preload" href="/_next/static/css/189f372a1a09b44bc5ee9e8694cd22967121ee9f_CSS.48deeafe.chunk.css" as="style"/><link rel="stylesheet" href="/_next/static/css/189f372a1a09b44bc5ee9e8694cd22967121ee9f_CSS.48deeafe.chunk.css" data-n-g=""/><link rel="preload" href="/_next/static/css/712a84a73acf62bf26290958298b2566586e7dd8_CSS.77aeb35e.chunk.css" as="style"/><link rel="stylesheet" href="/_next/static/css/712a84a73acf62bf26290958298b2566586e7dd8_CSS.77aeb35e.chunk.css" data-n-g=""/><link rel="preload" href="/_next/static/css/93b2fd6e127d30331b61cfd2f04634ca05024a66_CSS.c9bcc403.chunk.css" as="style"/><link rel="stylesheet" href="/_next/static/css/93b2fd6e127d30331b61cfd2f04634ca05024a66_CSS.c9bcc403.chunk.css" data-n-g=""/><link rel="preload" href="/_next/static/css/styles.a71acdf5.chunk.css" as="style"/><link rel="stylesheet" href="/_next/static/css/styles.a71acdf5.chunk.css" data-n-g=""/><link rel="preload" href="/_next/static/css/8a4b9c7b11a9228b425c7a73cade1154f2ca061e_CSS.0b204744.chunk.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8a4b9c7b11a9228b425c7a73cade1154f2ca061e_CSS.0b204744.chunk.css" data-n-p=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/_next/static/chunks/main-9e14e9299d96e4a63fc3.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-d7b2fb72fb7257504a38.js" as="script"/><link rel="preload" href="/_next/static/chunks/7af46002.7b37a38a8911fc5fb44b.js" as="script"/><link rel="preload" href="/_next/static/chunks/7658eb265201359a3f9e5f36a5d51cd74c781bde.716fe7386381de1064b0.js" as="script"/><link rel="preload" href="/_next/static/chunks/189f372a1a09b44bc5ee9e8694cd22967121ee9f.c1299753f6cf9d140411.js" as="script"/><link rel="preload" href="/_next/static/chunks/189f372a1a09b44bc5ee9e8694cd22967121ee9f_CSS.8f6f5b95f5e92b2c9bcd.js" as="script"/><link rel="preload" href="/_next/static/chunks/712a84a73acf62bf26290958298b2566586e7dd8_CSS.bca366718f045dbe8189.js" as="script"/><link rel="preload" href="/_next/static/chunks/93b2fd6e127d30331b61cfd2f04634ca05024a66_CSS.19830e50427f38e47434.js" as="script"/><link rel="preload" href="/_next/static/chunks/608d37238a334f4b11fe8d600201fe11b7a5b804.cbf6dda1e316f22fd86b.js" as="script"/><link rel="preload" href="/_next/static/chunks/d111f78934af154ae2b78def2cd48076645f6685.b41fcd8fbee89b9b32b6.js" as="script"/><link rel="preload" href="/_next/static/chunks/e70a2e0268e458e8b9abc18785a5727107407f8e.3f5af21948b0ca66102f.js" as="script"/><link rel="preload" href="/_next/static/chunks/styles.97cfe1edb1cdc49560a5.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-307ac3bfcacd4d7be388.js" as="script"/><link rel="preload" href="/_next/static/chunks/8a4b9c7b11a9228b425c7a73cade1154f2ca061e.4a1b4be1a94f0b02499c.js" as="script"/><link rel="preload" href="/_next/static/chunks/8a4b9c7b11a9228b425c7a73cade1154f2ca061e_CSS.4d62413f4da81be1e932.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-c6ffa8c08f20ac6ea580.js" as="script"/></head><body><div id="__next"><div><section class="ant-layout"><header class="ant-layout-header ki-header"><div class="ant-row ant-row-center ant-row-middle" style="height:100%"><div class="title-panel"><a class="header-title" href="/">· KIYAK ·</a></div></div></header><main class="ant-layout-content" style="margin-top:50px;padding-left:2px;padding-right:2px;padding-top:2px"><div style="overflow:hidden"><div id="posts-panel"><div class="ant-row ant-row-center"><div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-18 ant-col-lg-13"><div id="posts-content"><h1>个人网站开发实践</h1>
<p>必备：<a href="https://nodejs.org/en/">NodeJs</a> 、<a href="http://nginx.org/en/download.html">Nginx</a></p>
<h2>使用Next.js</h2>
<p>网站的开发采用 <strong><a href="https://nextjs.org/">Next.js</a></strong>，Next.js 具有自动代码拆分、预渲染、基于文件系统路由等等便利于开发的特性 ☕</p>
<p>官方在 Github 上列出了许多例子 👉 <a href="https://github.com/zeit/next.js/tree/canary/examples">example</a> ，以 <a href="https://github.com/zeit/next.js/tree/canary/examples/with-ant-design-less">with-ant-design-less</a> 为例，在 cmd 面板下运行以下命令</p>
<pre><code class="language-sh">npm init next-app --example with-ant-design-less projectname
npm install
npm run dev
</code></pre>
<p>访问 <a href="http://localhost:3000/">http://localhost:3000</a>，可以看到如下页面：</p>
<p><img src="https://resource.1024kb.top/image/code-sample/welcome-to-nextjs.png" alt="Welcome to Next.js">
<small style='text-align: center'>图片来自Next.js官网</small></p>
<h2>使用nginx的gzip压缩功能</h2>
<p>为了加快访问网站的速度，必须将网站的 js、css、html等文件尽量变得足够小，网络的传输才能足够快</p>
<p>首先使用 webpack 可视化分析插件： <a href="https://www.npmjs.com/package/webpack-bundle-analyzer">webpack-bundle-analyzer</a> ，并且构建已有项目：<code>npm run build</code><br>
构建将产生的文件一一罗列并且生成依赖关系图，效果如下：</p>
<p><img src="https://resource.1024kb.top/image/code-sample/webpack-analysis-1.png" alt="img"></p>
<p>观察构建的文件大小，以 9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc.js 为例，大小为 123.61kb，在网络传输中，100+kb算是可以接受的大小了，但幸运的是，还能做到更小！</p>
<p><img src="https://resource.1024kb.top/image/code-sample/webpack-analysis-2.png" alt="img"></p>
<p>nginx 提供了一个开箱即用的压缩功能 <strong>gzip</strong>，但默认情况下，gzip 设置是不开启的，在官网下载的 nginx 里，nginx.conf 文件会有这一行代码：</p>
<pre><code class="language-nginx">#gzip on;
</code></pre>
<p>此时对 gzip 功能不做任何变动，将构建好的静态项目放入 nginx 并且启动本地服务。打开网页，搜索文件名称 9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc.js</p>
<p><img src="https://resource.1024kb.top/image/code-sample/9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc.png" alt="img"></p>
<p>可以看到文件传输的大小为：127kb (左下角 - transferred)</p>
<p>重新打开 nginx.conf 文件并且编辑如下内容：</p>
<pre><code class="language-nginx">#开启gzip压缩
gzip on;
#压缩级别1~9，值越大压缩越好，但耗费越多CPU资源
gzip_comp_level 1;
#文件大于1k才进行压缩
gzip_min_length 1k;
#gz后缀文件不压缩
gzip_static off;
#是否在http header中添加Vary: Accept-Encoding
gzip_vary on;
#指定压缩的文件类型
gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript;
#指定压缩缓冲大小
gzip_buffers 2 4k;
</code></pre>
<p>保存之后重新启动 nginx：<code>nginx -s reload</code>，再次访问网页</p>
<p><img src="https://resource.1024kb.top/image/code-sample/9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc-2.png" alt="img"></p>
<p>响应头增加了 <code>Content-Encoding: gzip</code>，文件也减小了，变成41.6kb！</p>
<h2>使用nginx缓存</h2>
<p>同样在 nginx.conf 文件里增加如下内容，重启 nginx</p>
<pre><code class="language-nginx">#图片缓存时间设置
location ~* \.(gif|jpg|jpeg|png|bmp|swf|ico)$ {
    expires 24h;
    add_header Cache-Control "public";
}
#JS和CSS缓存时间设置
location ~* \.(js|css)$ {
    expires 24h;
    add_header Cache-Control "public";
}
</code></pre>
<p>重新查看请求的响应头会多出一行指令： <strong>Cache-Control: max-age=86400</strong>，这可以告诉客户端将文件存到本地，在某段时间内(86400s)都将使用本地文件，而不是每次都去请求服务器。可减缓服务压力，同时提高页面响应速度</p>
<h2>使用compression-webpack-plugin插件</h2>
<blockquote>
<p>Prepare compressed versions of assets to serve them with Content-Encoding.</p>
</blockquote>
<p>该插件可将 webpack 构建生成的文件进行 gzip 压缩，生成对应的 gz 文件</p>
<p>例如 webpack 构建并且生成文件：</p>
<p>xxx.js - 80kb</p>
<hr>
<p>使用了 compression-webpack-plugin 插件之后：</p>
<p>xxx.js - 80kb</p>
<p>xxx.js.gz - 3kb</p>
<hr>
<p>该做法旨在提前将文件进行压缩，在推送到服务器之后可直接使用压缩好的 gz 文件，而不是使用服务器的 CPU 资源进行文件的压缩操作。要想 nginx 能够直接利用 gz 文件，需要开启 gzip_static 功能。</p>
<pre><code class="language-nginx">gzip_static on;
</code></pre>
<h2>部署</h2>
<p>采用 Jenkins 、Git、Docker 实现快速的版本迭代更新。</p>
<p><img src="https://resource.1024kb.top/image/code-sample/CI&#x26;CD.png?v=2" alt="img"></p>
<p>思路：</p>
<ol>
<li>将本地开发的代码提交 github </li>
<li>启动 Jenkins 流水线<ol>
<li>拉取最新代码：git pull</li>
<li>下载依赖： npm i</li>
<li>构建项目：npm run build</li>
<li>打包必要文件：nginx.conf、start.sh<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup> 、Dockerfile、out<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup></li>
</ol></li>
<li>将打包好的文件发布到 Cenos 服务器，执行 start.sh</li>
<li>Docker 生成 nginx 镜像，根据镜像构建一个 Docker 容器，并将 nginx.conf、out 文件放入容器指定的位置</li>
</ol>
<p>start.sh</p>
<pre><code class="language-sh">#!/bin/bash
BASE_PATH=/kiyak/kiyak-web
SERVER_NAME=kiyak-web
KIYAK_CONTAINER=$(docker ps -a | grep "${SERVER_NAME}" | awk '{print $1}')
KIYAK_IMAGE=$(docker images | grep "${SERVER_NAME}" | awk '{print $3}')
KIYAK_NET_WORK=snail-net

# 构建docker镜像
if [ -n "$KIYAK_CONTAINER" ]
then
  echo "存在$SERVER_NAME容器，ID=$KIYAK_CONTAINER"
  echo "停止$SERVER_NAME容器，ID=$KIYAK_CONTAINER"
  docker stop $KIYAK_CONTAINER
  echo "删除$SERVER_NAME容器，ID=$KIYAK_CONTAINER"
  docker rm $KIYAK_CONTAINER
fi

if [ -n "$KIYAK_IMAGE" ]
then
  echo "存在$SERVER_NAME镜像，ID=$KIYAK_IMAGE"
  echo "删除$SERVER_NAME镜像，ID=$KIYAK_IMAGE"
  docker image rm $KIYAK_IMAGE
fi

cd $BASE_PATH
echo "创建$SERVER_NAME镜像......"
docker build -t $SERVER_NAME .
echo "启动$SERVER_NAME容器......"
docker run --name $SERVER_NAME -u root -p 80:80 -p 443:443 -v /etc/localtime:/etc/localtime:ro -v /kiyak/web-log:/etc/nginx/logs --network $KIYAK_NET_WORK -d $SERVER_NAME

# 清理文件
rm -rf $BASE_PATH/*
</code></pre>
<p>Dockerfile</p>
<pre><code class="language-markdown">FROM nginx
EXPOSE 80 443
ADD kiyak-web.tar.gz /etc/nginx/kiyak-web/
ADD cert.tar.gz /etc/nginx/
COPY nginx.conf /etc/nginx/nginx.conf
</code></pre>
<h1>参考资料</h1>
<ul>
<li>Jeff Posnick, Ilya Grigorik, Prevent unnecessary network requests with the HTTP Cache, <em>web.dev</em>, 2020. <a href="https://web.dev/http-cache/">📄</a></li>
<li>Marc Novakowski, Oliver Weichhold, “ETag vs Header Expires”, <em>Stack Overflow</em>, 2014 <a href="https://stackoverflow.com/a/500103">📄</a></li>
</ul>
<div class="footnotes">
<hr>
<ol>
<li id="fn-1">Shell 脚本，主要集成操作 docker 的各种命令行<a href="#fnref-1" class="footnote-backref">↩</a></li>
<li id="fn-2">webpack 构建生成的文件夹，里面包含项目的所有静态文件：js、css、html<a href="#fnref-2" class="footnote-backref">↩</a></li>
</ol>
</div>
</div></div></div><div style="position:fixed;bottom:150px;right:50px"><nav id="posts-nav"><ul style="list-style:none"></ul></nav></div><div class="ant-row ant-row-center" style="margin-bottom:40px;margin-top:40px"><span class="ant-typography"><u>· last updated：<!-- --> ·</u></span></div></div></div><span style="position:fixed;bottom:60px;right:15px;z-index:999;background-color:#555555" class="ant-avatar ant-avatar-lg ant-avatar-circle ant-avatar-icon ant-dropdown-trigger"><span role="img" aria-label="unordered-list" class="anticon anticon-unordered-list"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="unordered-list" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 10112 0 56 56 0 10-112 0zm0 284a56 56 0 10112 0 56 56 0 10-112 0zm0 284a56 56 0 10112 0 56 56 0 10-112 0z"></path></svg></span></span><div style="display:none" class="web-map"><a href="/">主页</a><a href="/notes">笔记</a></div></main><footer class="ant-layout-footer ki-footer"><a href="http://www.beian.miit.gov.cn" target="_blank" style="color:rgba(250, 250, 250, 0.938)">桂ICP备18000815号-2 © 2017 - 2020 - KIYAK-WEB</a></footer></section></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"filename":"个人网站开发实践.md","title":"个人网站开发实践","excerpt":"记录下一些开发内容或者优化心得","date":"2019-01-20T18:35:07.322Z","updated":"2020-05-26T14:02:00.000Z","preText":"👍","preTextColor":"#ffddbb","content":"\u003ch1\u003e个人网站开发实践\u003c/h1\u003e\n\u003cp\u003e必备：\u003ca href=\"https://nodejs.org/en/\"\u003eNodeJs\u003c/a\u003e 、\u003ca href=\"http://nginx.org/en/download.html\"\u003eNginx\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003e使用Next.js\u003c/h2\u003e\n\u003cp\u003e网站的开发采用 \u003cstrong\u003e\u003ca href=\"https://nextjs.org/\"\u003eNext.js\u003c/a\u003e\u003c/strong\u003e，Next.js 具有自动代码拆分、预渲染、基于文件系统路由等等便利于开发的特性 ☕\u003c/p\u003e\n\u003cp\u003e官方在 Github 上列出了许多例子 👉 \u003ca href=\"https://github.com/zeit/next.js/tree/canary/examples\"\u003eexample\u003c/a\u003e ，以 \u003ca href=\"https://github.com/zeit/next.js/tree/canary/examples/with-ant-design-less\"\u003ewith-ant-design-less\u003c/a\u003e 为例，在 cmd 面板下运行以下命令\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sh\"\u003enpm init next-app --example with-ant-design-less projectname\nnpm install\nnpm run dev\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e访问 \u003ca href=\"http://localhost:3000/\"\u003ehttp://localhost:3000\u003c/a\u003e，可以看到如下页面：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://resource.1024kb.top/image/code-sample/welcome-to-nextjs.png\" alt=\"Welcome to Next.js\"\u003e\n\u003csmall style='text-align: center'\u003e图片来自Next.js官网\u003c/small\u003e\u003c/p\u003e\n\u003ch2\u003e使用nginx的gzip压缩功能\u003c/h2\u003e\n\u003cp\u003e为了加快访问网站的速度，必须将网站的 js、css、html等文件尽量变得足够小，网络的传输才能足够快\u003c/p\u003e\n\u003cp\u003e首先使用 webpack 可视化分析插件： \u003ca href=\"https://www.npmjs.com/package/webpack-bundle-analyzer\"\u003ewebpack-bundle-analyzer\u003c/a\u003e ，并且构建已有项目：\u003ccode\u003enpm run build\u003c/code\u003e\u003cbr\u003e\n构建将产生的文件一一罗列并且生成依赖关系图，效果如下：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://resource.1024kb.top/image/code-sample/webpack-analysis-1.png\" alt=\"img\"\u003e\u003c/p\u003e\n\u003cp\u003e观察构建的文件大小，以 9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc.js 为例，大小为 123.61kb，在网络传输中，100+kb算是可以接受的大小了，但幸运的是，还能做到更小！\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://resource.1024kb.top/image/code-sample/webpack-analysis-2.png\" alt=\"img\"\u003e\u003c/p\u003e\n\u003cp\u003enginx 提供了一个开箱即用的压缩功能 \u003cstrong\u003egzip\u003c/strong\u003e，但默认情况下，gzip 设置是不开启的，在官网下载的 nginx 里，nginx.conf 文件会有这一行代码：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-nginx\"\u003e#gzip on;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e此时对 gzip 功能不做任何变动，将构建好的静态项目放入 nginx 并且启动本地服务。打开网页，搜索文件名称 9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc.js\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://resource.1024kb.top/image/code-sample/9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc.png\" alt=\"img\"\u003e\u003c/p\u003e\n\u003cp\u003e可以看到文件传输的大小为：127kb (左下角 - transferred)\u003c/p\u003e\n\u003cp\u003e重新打开 nginx.conf 文件并且编辑如下内容：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-nginx\"\u003e#开启gzip压缩\ngzip on;\n#压缩级别1~9，值越大压缩越好，但耗费越多CPU资源\ngzip_comp_level 1;\n#文件大于1k才进行压缩\ngzip_min_length 1k;\n#gz后缀文件不压缩\ngzip_static off;\n#是否在http header中添加Vary: Accept-Encoding\ngzip_vary on;\n#指定压缩的文件类型\ngzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript;\n#指定压缩缓冲大小\ngzip_buffers 2 4k;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e保存之后重新启动 nginx：\u003ccode\u003enginx -s reload\u003c/code\u003e，再次访问网页\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://resource.1024kb.top/image/code-sample/9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc-2.png\" alt=\"img\"\u003e\u003c/p\u003e\n\u003cp\u003e响应头增加了 \u003ccode\u003eContent-Encoding: gzip\u003c/code\u003e，文件也减小了，变成41.6kb！\u003c/p\u003e\n\u003ch2\u003e使用nginx缓存\u003c/h2\u003e\n\u003cp\u003e同样在 nginx.conf 文件里增加如下内容，重启 nginx\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-nginx\"\u003e#图片缓存时间设置\nlocation ~* \\.(gif|jpg|jpeg|png|bmp|swf|ico)$ {\n    expires 24h;\n    add_header Cache-Control \"public\";\n}\n#JS和CSS缓存时间设置\nlocation ~* \\.(js|css)$ {\n    expires 24h;\n    add_header Cache-Control \"public\";\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e重新查看请求的响应头会多出一行指令： \u003cstrong\u003eCache-Control: max-age=86400\u003c/strong\u003e，这可以告诉客户端将文件存到本地，在某段时间内(86400s)都将使用本地文件，而不是每次都去请求服务器。可减缓服务压力，同时提高页面响应速度\u003c/p\u003e\n\u003ch2\u003e使用compression-webpack-plugin插件\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003ePrepare compressed versions of assets to serve them with Content-Encoding.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e该插件可将 webpack 构建生成的文件进行 gzip 压缩，生成对应的 gz 文件\u003c/p\u003e\n\u003cp\u003e例如 webpack 构建并且生成文件：\u003c/p\u003e\n\u003cp\u003exxx.js - 80kb\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e使用了 compression-webpack-plugin 插件之后：\u003c/p\u003e\n\u003cp\u003exxx.js - 80kb\u003c/p\u003e\n\u003cp\u003exxx.js.gz - 3kb\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e该做法旨在提前将文件进行压缩，在推送到服务器之后可直接使用压缩好的 gz 文件，而不是使用服务器的 CPU 资源进行文件的压缩操作。要想 nginx 能够直接利用 gz 文件，需要开启 gzip_static 功能。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-nginx\"\u003egzip_static on;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e部署\u003c/h2\u003e\n\u003cp\u003e采用 Jenkins 、Git、Docker 实现快速的版本迭代更新。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://resource.1024kb.top/image/code-sample/CI\u0026#x26;CD.png?v=2\" alt=\"img\"\u003e\u003c/p\u003e\n\u003cp\u003e思路：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e将本地开发的代码提交 github \u003c/li\u003e\n\u003cli\u003e启动 Jenkins 流水线\u003col\u003e\n\u003cli\u003e拉取最新代码：git pull\u003c/li\u003e\n\u003cli\u003e下载依赖： npm i\u003c/li\u003e\n\u003cli\u003e构建项目：npm run build\u003c/li\u003e\n\u003cli\u003e打包必要文件：nginx.conf、start.sh\u003csup id=\"fnref-1\"\u003e\u003ca href=\"#fn-1\" class=\"footnote-ref\"\u003e1\u003c/a\u003e\u003c/sup\u003e 、Dockerfile、out\u003csup id=\"fnref-2\"\u003e\u003ca href=\"#fn-2\" class=\"footnote-ref\"\u003e2\u003c/a\u003e\u003c/sup\u003e\u003c/li\u003e\n\u003c/ol\u003e\u003c/li\u003e\n\u003cli\u003e将打包好的文件发布到 Cenos 服务器，执行 start.sh\u003c/li\u003e\n\u003cli\u003eDocker 生成 nginx 镜像，根据镜像构建一个 Docker 容器，并将 nginx.conf、out 文件放入容器指定的位置\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003estart.sh\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sh\"\u003e#!/bin/bash\nBASE_PATH=/kiyak/kiyak-web\nSERVER_NAME=kiyak-web\nKIYAK_CONTAINER=$(docker ps -a | grep \"${SERVER_NAME}\" | awk '{print $1}')\nKIYAK_IMAGE=$(docker images | grep \"${SERVER_NAME}\" | awk '{print $3}')\nKIYAK_NET_WORK=snail-net\n\n# 构建docker镜像\nif [ -n \"$KIYAK_CONTAINER\" ]\nthen\n  echo \"存在$SERVER_NAME容器，ID=$KIYAK_CONTAINER\"\n  echo \"停止$SERVER_NAME容器，ID=$KIYAK_CONTAINER\"\n  docker stop $KIYAK_CONTAINER\n  echo \"删除$SERVER_NAME容器，ID=$KIYAK_CONTAINER\"\n  docker rm $KIYAK_CONTAINER\nfi\n\nif [ -n \"$KIYAK_IMAGE\" ]\nthen\n  echo \"存在$SERVER_NAME镜像，ID=$KIYAK_IMAGE\"\n  echo \"删除$SERVER_NAME镜像，ID=$KIYAK_IMAGE\"\n  docker image rm $KIYAK_IMAGE\nfi\n\ncd $BASE_PATH\necho \"创建$SERVER_NAME镜像......\"\ndocker build -t $SERVER_NAME .\necho \"启动$SERVER_NAME容器......\"\ndocker run --name $SERVER_NAME -u root -p 80:80 -p 443:443 -v /etc/localtime:/etc/localtime:ro -v /kiyak/web-log:/etc/nginx/logs --network $KIYAK_NET_WORK -d $SERVER_NAME\n\n# 清理文件\nrm -rf $BASE_PATH/*\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eDockerfile\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-markdown\"\u003eFROM nginx\nEXPOSE 80 443\nADD kiyak-web.tar.gz /etc/nginx/kiyak-web/\nADD cert.tar.gz /etc/nginx/\nCOPY nginx.conf /etc/nginx/nginx.conf\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003e参考资料\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003eJeff Posnick, Ilya Grigorik, Prevent unnecessary network requests with the HTTP Cache, \u003cem\u003eweb.dev\u003c/em\u003e, 2020. \u003ca href=\"https://web.dev/http-cache/\"\u003e📄\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eMarc Novakowski, Oliver Weichhold, “ETag vs Header Expires”, \u003cem\u003eStack Overflow\u003c/em\u003e, 2014 \u003ca href=\"https://stackoverflow.com/a/500103\"\u003e📄\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr\u003e\n\u003col\u003e\n\u003cli id=\"fn-1\"\u003eShell 脚本，主要集成操作 docker 的各种命令行\u003ca href=\"#fnref-1\" class=\"footnote-backref\"\u003e↩\u003c/a\u003e\u003c/li\u003e\n\u003cli id=\"fn-2\"\u003ewebpack 构建生成的文件夹，里面包含项目的所有静态文件：js、css、html\u003ca href=\"#fnref-2\" class=\"footnote-backref\"\u003e↩\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/div\u003e\n"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"personal-website-development-practice"},"buildId":"pGGBVmnLCT4XKOq0_CdKw","nextExport":false,"isFallback":false,"gsp":true,"head":[["meta",{"name":"viewport","content":"width=device-width"}],["meta",{"charSet":"utf-8"}],["title",{"children":"个人网站开发实践 - kiyak"}]]}</script><script nomodule="" src="/_next/static/chunks/polyfills-577caaa53936537aa4bf.js"></script><script src="/_next/static/chunks/main-9e14e9299d96e4a63fc3.js" async=""></script><script src="/_next/static/chunks/webpack-d7b2fb72fb7257504a38.js" async=""></script><script src="/_next/static/chunks/7af46002.7b37a38a8911fc5fb44b.js" async=""></script><script src="/_next/static/chunks/7658eb265201359a3f9e5f36a5d51cd74c781bde.716fe7386381de1064b0.js" async=""></script><script src="/_next/static/chunks/189f372a1a09b44bc5ee9e8694cd22967121ee9f.c1299753f6cf9d140411.js" async=""></script><script src="/_next/static/chunks/189f372a1a09b44bc5ee9e8694cd22967121ee9f_CSS.8f6f5b95f5e92b2c9bcd.js" async=""></script><script src="/_next/static/chunks/712a84a73acf62bf26290958298b2566586e7dd8_CSS.bca366718f045dbe8189.js" async=""></script><script src="/_next/static/chunks/93b2fd6e127d30331b61cfd2f04634ca05024a66_CSS.19830e50427f38e47434.js" async=""></script><script src="/_next/static/chunks/608d37238a334f4b11fe8d600201fe11b7a5b804.cbf6dda1e316f22fd86b.js" async=""></script><script src="/_next/static/chunks/d111f78934af154ae2b78def2cd48076645f6685.b41fcd8fbee89b9b32b6.js" async=""></script><script src="/_next/static/chunks/e70a2e0268e458e8b9abc18785a5727107407f8e.3f5af21948b0ca66102f.js" async=""></script><script src="/_next/static/chunks/styles.97cfe1edb1cdc49560a5.js" async=""></script><script src="/_next/static/chunks/pages/_app-307ac3bfcacd4d7be388.js" async=""></script><script src="/_next/static/chunks/8a4b9c7b11a9228b425c7a73cade1154f2ca061e.4a1b4be1a94f0b02499c.js" async=""></script><script src="/_next/static/chunks/8a4b9c7b11a9228b425c7a73cade1154f2ca061e_CSS.4d62413f4da81be1e932.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-c6ffa8c08f20ac6ea580.js" async=""></script><script src="/_next/static/pGGBVmnLCT4XKOq0_CdKw/_buildManifest.js" async=""></script><script src="/_next/static/pGGBVmnLCT4XKOq0_CdKw/_ssgManifest.js" async=""></script></body></html>