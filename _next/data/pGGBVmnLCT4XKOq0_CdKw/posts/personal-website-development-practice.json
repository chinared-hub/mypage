{"pageProps":{"post":{"filename":"ä¸ªäººç½‘ç«™å¼€å‘å®è·µ.md","title":"ä¸ªäººç½‘ç«™å¼€å‘å®è·µ","excerpt":"è®°å½•ä¸‹ä¸€äº›å¼€å‘å†…å®¹æˆ–è€…ä¼˜åŒ–å¿ƒå¾—","date":"2019-01-20T18:35:07.322Z","updated":"2020-05-26T14:02:00.000Z","preText":"ğŸ‘","preTextColor":"#ffddbb","content":"<h1>ä¸ªäººç½‘ç«™å¼€å‘å®è·µ</h1>\n<p>å¿…å¤‡ï¼š<a href=\"https://nodejs.org/en/\">NodeJs</a> ã€<a href=\"http://nginx.org/en/download.html\">Nginx</a></p>\n<h2>ä½¿ç”¨Next.js</h2>\n<p>ç½‘ç«™çš„å¼€å‘é‡‡ç”¨ <strong><a href=\"https://nextjs.org/\">Next.js</a></strong>ï¼ŒNext.js å…·æœ‰è‡ªåŠ¨ä»£ç æ‹†åˆ†ã€é¢„æ¸²æŸ“ã€åŸºäºæ–‡ä»¶ç³»ç»Ÿè·¯ç”±ç­‰ç­‰ä¾¿åˆ©äºå¼€å‘çš„ç‰¹æ€§ â˜•</p>\n<p>å®˜æ–¹åœ¨ Github ä¸Šåˆ—å‡ºäº†è®¸å¤šä¾‹å­ ğŸ‘‰ <a href=\"https://github.com/zeit/next.js/tree/canary/examples\">example</a> ï¼Œä»¥ <a href=\"https://github.com/zeit/next.js/tree/canary/examples/with-ant-design-less\">with-ant-design-less</a> ä¸ºä¾‹ï¼Œåœ¨ cmd é¢æ¿ä¸‹è¿è¡Œä»¥ä¸‹å‘½ä»¤</p>\n<pre><code class=\"language-sh\">npm init next-app --example with-ant-design-less projectname\nnpm install\nnpm run dev\n</code></pre>\n<p>è®¿é—® <a href=\"http://localhost:3000/\">http://localhost:3000</a>ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹é¡µé¢ï¼š</p>\n<p><img src=\"https://resource.1024kb.top/image/code-sample/welcome-to-nextjs.png\" alt=\"Welcome to Next.js\">\n<small style='text-align: center'>å›¾ç‰‡æ¥è‡ªNext.jså®˜ç½‘</small></p>\n<h2>ä½¿ç”¨nginxçš„gzipå‹ç¼©åŠŸèƒ½</h2>\n<p>ä¸ºäº†åŠ å¿«è®¿é—®ç½‘ç«™çš„é€Ÿåº¦ï¼Œå¿…é¡»å°†ç½‘ç«™çš„ jsã€cssã€htmlç­‰æ–‡ä»¶å°½é‡å˜å¾—è¶³å¤Ÿå°ï¼Œç½‘ç»œçš„ä¼ è¾“æ‰èƒ½è¶³å¤Ÿå¿«</p>\n<p>é¦–å…ˆä½¿ç”¨ webpack å¯è§†åŒ–åˆ†ææ’ä»¶ï¼š <a href=\"https://www.npmjs.com/package/webpack-bundle-analyzer\">webpack-bundle-analyzer</a> ï¼Œå¹¶ä¸”æ„å»ºå·²æœ‰é¡¹ç›®ï¼š<code>npm run build</code><br>\næ„å»ºå°†äº§ç”Ÿçš„æ–‡ä»¶ä¸€ä¸€ç½—åˆ—å¹¶ä¸”ç”Ÿæˆä¾èµ–å…³ç³»å›¾ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>\n<p><img src=\"https://resource.1024kb.top/image/code-sample/webpack-analysis-1.png\" alt=\"img\"></p>\n<p>è§‚å¯Ÿæ„å»ºçš„æ–‡ä»¶å¤§å°ï¼Œä»¥ 9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc.js ä¸ºä¾‹ï¼Œå¤§å°ä¸º 123.61kbï¼Œåœ¨ç½‘ç»œä¼ è¾“ä¸­ï¼Œ100+kbç®—æ˜¯å¯ä»¥æ¥å—çš„å¤§å°äº†ï¼Œä½†å¹¸è¿çš„æ˜¯ï¼Œè¿˜èƒ½åšåˆ°æ›´å°ï¼</p>\n<p><img src=\"https://resource.1024kb.top/image/code-sample/webpack-analysis-2.png\" alt=\"img\"></p>\n<p>nginx æä¾›äº†ä¸€ä¸ªå¼€ç®±å³ç”¨çš„å‹ç¼©åŠŸèƒ½ <strong>gzip</strong>ï¼Œä½†é»˜è®¤æƒ…å†µä¸‹ï¼Œgzip è®¾ç½®æ˜¯ä¸å¼€å¯çš„ï¼Œåœ¨å®˜ç½‘ä¸‹è½½çš„ nginx é‡Œï¼Œnginx.conf æ–‡ä»¶ä¼šæœ‰è¿™ä¸€è¡Œä»£ç ï¼š</p>\n<pre><code class=\"language-nginx\">#gzip on;\n</code></pre>\n<p>æ­¤æ—¶å¯¹ gzip åŠŸèƒ½ä¸åšä»»ä½•å˜åŠ¨ï¼Œå°†æ„å»ºå¥½çš„é™æ€é¡¹ç›®æ”¾å…¥ nginx å¹¶ä¸”å¯åŠ¨æœ¬åœ°æœåŠ¡ã€‚æ‰“å¼€ç½‘é¡µï¼Œæœç´¢æ–‡ä»¶åç§° 9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc.js</p>\n<p><img src=\"https://resource.1024kb.top/image/code-sample/9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc.png\" alt=\"img\"></p>\n<p>å¯ä»¥çœ‹åˆ°æ–‡ä»¶ä¼ è¾“çš„å¤§å°ä¸ºï¼š127kb (å·¦ä¸‹è§’ - transferred)</p>\n<p>é‡æ–°æ‰“å¼€ nginx.conf æ–‡ä»¶å¹¶ä¸”ç¼–è¾‘å¦‚ä¸‹å†…å®¹ï¼š</p>\n<pre><code class=\"language-nginx\">#å¼€å¯gzipå‹ç¼©\ngzip on;\n#å‹ç¼©çº§åˆ«1~9ï¼Œå€¼è¶Šå¤§å‹ç¼©è¶Šå¥½ï¼Œä½†è€—è´¹è¶Šå¤šCPUèµ„æº\ngzip_comp_level 1;\n#æ–‡ä»¶å¤§äº1kæ‰è¿›è¡Œå‹ç¼©\ngzip_min_length 1k;\n#gzåç¼€æ–‡ä»¶ä¸å‹ç¼©\ngzip_static off;\n#æ˜¯å¦åœ¨http headerä¸­æ·»åŠ Vary: Accept-Encoding\ngzip_vary on;\n#æŒ‡å®šå‹ç¼©çš„æ–‡ä»¶ç±»å‹\ngzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript;\n#æŒ‡å®šå‹ç¼©ç¼“å†²å¤§å°\ngzip_buffers 2 4k;\n</code></pre>\n<p>ä¿å­˜ä¹‹åé‡æ–°å¯åŠ¨ nginxï¼š<code>nginx -s reload</code>ï¼Œå†æ¬¡è®¿é—®ç½‘é¡µ</p>\n<p><img src=\"https://resource.1024kb.top/image/code-sample/9c3bc3cde28db290887b7e6d1f1907160b18de5e.547bf9fb904ff2a9c3bc-2.png\" alt=\"img\"></p>\n<p>å“åº”å¤´å¢åŠ äº† <code>Content-Encoding: gzip</code>ï¼Œæ–‡ä»¶ä¹Ÿå‡å°äº†ï¼Œå˜æˆ41.6kbï¼</p>\n<h2>ä½¿ç”¨nginxç¼“å­˜</h2>\n<p>åŒæ ·åœ¨ nginx.conf æ–‡ä»¶é‡Œå¢åŠ å¦‚ä¸‹å†…å®¹ï¼Œé‡å¯ nginx</p>\n<pre><code class=\"language-nginx\">#å›¾ç‰‡ç¼“å­˜æ—¶é—´è®¾ç½®\nlocation ~* \\.(gif|jpg|jpeg|png|bmp|swf|ico)$ {\n    expires 24h;\n    add_header Cache-Control \"public\";\n}\n#JSå’ŒCSSç¼“å­˜æ—¶é—´è®¾ç½®\nlocation ~* \\.(js|css)$ {\n    expires 24h;\n    add_header Cache-Control \"public\";\n}\n</code></pre>\n<p>é‡æ–°æŸ¥çœ‹è¯·æ±‚çš„å“åº”å¤´ä¼šå¤šå‡ºä¸€è¡ŒæŒ‡ä»¤ï¼š <strong>Cache-Control: max-age=86400</strong>ï¼Œè¿™å¯ä»¥å‘Šè¯‰å®¢æˆ·ç«¯å°†æ–‡ä»¶å­˜åˆ°æœ¬åœ°ï¼Œåœ¨æŸæ®µæ—¶é—´å†…(86400s)éƒ½å°†ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½å»è¯·æ±‚æœåŠ¡å™¨ã€‚å¯å‡ç¼“æœåŠ¡å‹åŠ›ï¼ŒåŒæ—¶æé«˜é¡µé¢å“åº”é€Ÿåº¦</p>\n<h2>ä½¿ç”¨compression-webpack-pluginæ’ä»¶</h2>\n<blockquote>\n<p>Prepare compressed versions of assets to serve them with Content-Encoding.</p>\n</blockquote>\n<p>è¯¥æ’ä»¶å¯å°† webpack æ„å»ºç”Ÿæˆçš„æ–‡ä»¶è¿›è¡Œ gzip å‹ç¼©ï¼Œç”Ÿæˆå¯¹åº”çš„ gz æ–‡ä»¶</p>\n<p>ä¾‹å¦‚ webpack æ„å»ºå¹¶ä¸”ç”Ÿæˆæ–‡ä»¶ï¼š</p>\n<p>xxx.js - 80kb</p>\n<hr>\n<p>ä½¿ç”¨äº† compression-webpack-plugin æ’ä»¶ä¹‹åï¼š</p>\n<p>xxx.js - 80kb</p>\n<p>xxx.js.gz - 3kb</p>\n<hr>\n<p>è¯¥åšæ³•æ—¨åœ¨æå‰å°†æ–‡ä»¶è¿›è¡Œå‹ç¼©ï¼Œåœ¨æ¨é€åˆ°æœåŠ¡å™¨ä¹‹åå¯ç›´æ¥ä½¿ç”¨å‹ç¼©å¥½çš„ gz æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æœåŠ¡å™¨çš„ CPU èµ„æºè¿›è¡Œæ–‡ä»¶çš„å‹ç¼©æ“ä½œã€‚è¦æƒ³ nginx èƒ½å¤Ÿç›´æ¥åˆ©ç”¨ gz æ–‡ä»¶ï¼Œéœ€è¦å¼€å¯ gzip_static åŠŸèƒ½ã€‚</p>\n<pre><code class=\"language-nginx\">gzip_static on;\n</code></pre>\n<h2>éƒ¨ç½²</h2>\n<p>é‡‡ç”¨ Jenkins ã€Gitã€Docker å®ç°å¿«é€Ÿçš„ç‰ˆæœ¬è¿­ä»£æ›´æ–°ã€‚</p>\n<p><img src=\"https://resource.1024kb.top/image/code-sample/CI&#x26;CD.png?v=2\" alt=\"img\"></p>\n<p>æ€è·¯ï¼š</p>\n<ol>\n<li>å°†æœ¬åœ°å¼€å‘çš„ä»£ç æäº¤ github </li>\n<li>å¯åŠ¨ Jenkins æµæ°´çº¿<ol>\n<li>æ‹‰å–æœ€æ–°ä»£ç ï¼šgit pull</li>\n<li>ä¸‹è½½ä¾èµ–ï¼š npm i</li>\n<li>æ„å»ºé¡¹ç›®ï¼šnpm run build</li>\n<li>æ‰“åŒ…å¿…è¦æ–‡ä»¶ï¼šnginx.confã€start.sh<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup> ã€Dockerfileã€out<sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup></li>\n</ol></li>\n<li>å°†æ‰“åŒ…å¥½çš„æ–‡ä»¶å‘å¸ƒåˆ° Cenos æœåŠ¡å™¨ï¼Œæ‰§è¡Œ start.sh</li>\n<li>Docker ç”Ÿæˆ nginx é•œåƒï¼Œæ ¹æ®é•œåƒæ„å»ºä¸€ä¸ª Docker å®¹å™¨ï¼Œå¹¶å°† nginx.confã€out æ–‡ä»¶æ”¾å…¥å®¹å™¨æŒ‡å®šçš„ä½ç½®</li>\n</ol>\n<p>start.sh</p>\n<pre><code class=\"language-sh\">#!/bin/bash\nBASE_PATH=/kiyak/kiyak-web\nSERVER_NAME=kiyak-web\nKIYAK_CONTAINER=$(docker ps -a | grep \"${SERVER_NAME}\" | awk '{print $1}')\nKIYAK_IMAGE=$(docker images | grep \"${SERVER_NAME}\" | awk '{print $3}')\nKIYAK_NET_WORK=snail-net\n\n# æ„å»ºdockeré•œåƒ\nif [ -n \"$KIYAK_CONTAINER\" ]\nthen\n  echo \"å­˜åœ¨$SERVER_NAMEå®¹å™¨ï¼ŒID=$KIYAK_CONTAINER\"\n  echo \"åœæ­¢$SERVER_NAMEå®¹å™¨ï¼ŒID=$KIYAK_CONTAINER\"\n  docker stop $KIYAK_CONTAINER\n  echo \"åˆ é™¤$SERVER_NAMEå®¹å™¨ï¼ŒID=$KIYAK_CONTAINER\"\n  docker rm $KIYAK_CONTAINER\nfi\n\nif [ -n \"$KIYAK_IMAGE\" ]\nthen\n  echo \"å­˜åœ¨$SERVER_NAMEé•œåƒï¼ŒID=$KIYAK_IMAGE\"\n  echo \"åˆ é™¤$SERVER_NAMEé•œåƒï¼ŒID=$KIYAK_IMAGE\"\n  docker image rm $KIYAK_IMAGE\nfi\n\ncd $BASE_PATH\necho \"åˆ›å»º$SERVER_NAMEé•œåƒ......\"\ndocker build -t $SERVER_NAME .\necho \"å¯åŠ¨$SERVER_NAMEå®¹å™¨......\"\ndocker run --name $SERVER_NAME -u root -p 80:80 -p 443:443 -v /etc/localtime:/etc/localtime:ro -v /kiyak/web-log:/etc/nginx/logs --network $KIYAK_NET_WORK -d $SERVER_NAME\n\n# æ¸…ç†æ–‡ä»¶\nrm -rf $BASE_PATH/*\n</code></pre>\n<p>Dockerfile</p>\n<pre><code class=\"language-markdown\">FROM nginx\nEXPOSE 80 443\nADD kiyak-web.tar.gz /etc/nginx/kiyak-web/\nADD cert.tar.gz /etc/nginx/\nCOPY nginx.conf /etc/nginx/nginx.conf\n</code></pre>\n<h1>å‚è€ƒèµ„æ–™</h1>\n<ul>\n<li>Jeff Posnick, Ilya Grigorik, Prevent unnecessary network requests with the HTTP Cache, <em>web.dev</em>, 2020. <a href=\"https://web.dev/http-cache/\">ğŸ“„</a></li>\n<li>Marc Novakowski, Oliver Weichhold, â€œETag vs Header Expiresâ€, <em>Stack Overflow</em>, 2014 <a href=\"https://stackoverflow.com/a/500103\">ğŸ“„</a></li>\n</ul>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">Shell è„šæœ¬ï¼Œä¸»è¦é›†æˆæ“ä½œ docker çš„å„ç§å‘½ä»¤è¡Œ<a href=\"#fnref-1\" class=\"footnote-backref\">â†©</a></li>\n<li id=\"fn-2\">webpack æ„å»ºç”Ÿæˆçš„æ–‡ä»¶å¤¹ï¼Œé‡Œé¢åŒ…å«é¡¹ç›®çš„æ‰€æœ‰é™æ€æ–‡ä»¶ï¼šjsã€cssã€html<a href=\"#fnref-2\" class=\"footnote-backref\">â†©</a></li>\n</ol>\n</div>\n"}},"__N_SSG":true}